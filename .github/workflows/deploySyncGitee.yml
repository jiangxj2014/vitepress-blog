name: Deploy GitHub Pages and sync Gitee

# è§¦å‘æ¡ä»¶ï¼šåœ¨ push åˆ° master åˆ†æ”¯å
on:
  push:
    branches:
      - master

# ä»»åŠ¡
jobs:
  build-and-deploy:
    # æœåŠ¡å™¨ç¯å¢ƒï¼šæœ€æ–°ç‰ˆ Ubuntu
    runs-on: ubuntu-latest
    steps:
      # æ‹‰å–ä»£ç 
      - name: Checkout
        uses: actions/checkout@v2
        with:
          persist-credentials: false
      - uses: pnpm/action-setup@v3 # å¦‚æœä½¿ç”¨ pnpmï¼Œè¯·å–æ¶ˆæ³¨é‡Š
        with:
          version: 8

      # 1ã€ç”Ÿæˆé™æ€æ–‡ä»¶
      - name: Build
        run: pnpm install && pnpm docs:build

      # 2ã€éƒ¨ç½²åˆ° GitHub Pages
      - name: Deploy
        # v3ä¸v4ç‰ˆæœ¬ï¼Œé…ç½®å‚æ•°ä¸åŒï¼Œæ­¤å¤„ä½¿ç”¨v3ç‰ˆæœ¬
        uses: JamesIves/github-pages-deploy-action@releases/v3
        # éƒ¨ç½²åˆ° GitHub Pages çš„å‚æ•°
        with:
          # åˆ†æ”¯
          BRANCH: gh-pages
          # ç›®æ ‡æ–‡ä»¶å¤¹
          FOLDER: ./docs/.vitepress/dist
          # è®¿é—®ä»¤ç‰Œ
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          # éƒ¨ç½²ä»“åº“
          REPOSITORY_NAME: jiangxj2014/jiangxj2014.github.io
        
      # 3ã€åŒæ­¥åˆ° Gitee
      - name: Sync to Gitee
        uses: wearerequired/git-mirror-action@v1.2.0
        env:
          # æ³¨æ„åœ¨ Settings->Secrets é…ç½® GITEE_RSA_PRIVATE_KEY
          SSH_PRIVATE_KEY: ${{ secrets.GITEE_RSA_PRIVATE_KEY }}
        with:
          # æ³¨æ„æ›¿æ¢ä¸ºä½ çš„ GitHub æºä»“åº“åœ°å€
          # source-repo: https://github.com/jiangxj2014/jiangxj2014.github.io.git
          source-repo: git@github.com:jiangxj2014/jiangxj2014.github.io.git
          # æ³¨æ„æ›¿æ¢ä¸ºä½ çš„ Gitee ç›®æ ‡ä»“åº“åœ°å€
          destination-repo: git@gitee.com:jiangxj1314/jiangxj1314.git

      # ç”±äº Gitee Pages æš‚åœæœåŠ¡ï¼Œæ‰€ä»¥æ³¨é‡Šæ‰
      # # 4ã€è‡ªåŠ¨éƒ¨ç½² Gitee Pages
      # - name: Build Gitee Pages
      #   uses: yanglbme/gitee-pages-action@main
      #   with:
      #     # æ³¨æ„æ›¿æ¢ä¸ºä½ çš„ Gitee ç”¨æˆ·å
      #     gitee-username: jiangxj1314
      #     # æ³¨æ„åœ¨ Settings->Secrets é…ç½® GITEE_PASSWORD
      #     gitee-password: ${{ secrets.GITEE_PASSWORD }}
      #     # æ³¨æ„æ›¿æ¢ä¸ºä½ çš„ Gitee ä»“åº“ï¼Œä»“åº“åä¸¥æ ¼åŒºåˆ†å¤§å°å†™ï¼Œè¯·å‡†ç¡®å¡«å†™ï¼Œå¦åˆ™ä¼šå‡ºé”™
      #     gitee-repo: jiangxj1314/jiangxj1314
      #     # è¦éƒ¨ç½²çš„åˆ†æ”¯ï¼Œé»˜è®¤æ˜¯ masterï¼Œè‹¥æ˜¯å…¶ä»–åˆ†æ”¯ï¼Œåˆ™éœ€è¦æŒ‡å®šï¼ˆæŒ‡å®šçš„åˆ†æ”¯å¿…é¡»å­˜åœ¨ï¼‰
      #     branch: gh-pages

      # 5ã€å‘é€é’‰é’‰é€šçŸ¥
      - name: æˆåŠŸé€šçŸ¥
        if: ${{ success() }}
        uses: zcong1993/actions-ding@master
        with:
          dingToken: ${{ secrets.DING_TOKEN }}
          secret: ${{ secrets.DING_SECRET }} # if secret set, action will call API with sign
          body: |
            {
              "msgtype": "text",
              "text": {
                "content": "ğŸ‰ğŸ‰ğŸ‰é¡¹ç›®æ„å»ºæˆåŠŸğŸ‰ğŸ‰ğŸ‰\nä»“åº“ï¼š${{github.repository}}\né¢„è§ˆåœ°å€ï¼šhttps://jiangxj2014.github.io",                 
              }
            }

      - name: å¤±è´¥é€šçŸ¥
        if: ${{ failure() }}
        uses: zcong1993/actions-ding@master
        with:
          dingToken: ${{ secrets.DING_TOKEN }}
          secret: ${{ secrets.DING_SECRET }} # if secret set, action will call API with sign
          body: |
            {
              "msgtype": "text",
              "text": {
                "content": "ğŸ’£ğŸ’£ğŸ’£é¡¹ç›®æ„å»ºå¤±è´¥ğŸ’£ğŸ’£ğŸ’£\nä»“åº“ï¼š${{github.repository}}",                 
              }
            }
    
